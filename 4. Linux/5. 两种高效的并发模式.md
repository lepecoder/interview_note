并发的目的是让程序“同时”执行多个任务，对于IO密集型任务，阻塞的IO会浪费大量CPU时间，并发模式可以提高CPU利用率。并发模式指的是IO处理单元和逻辑单元之间协调完成任务的方法。

## 并发模式

### 半同步/半异步模式

这里的同步异步与IO模型中的概念不同，IO模型中的异步是指内核完成读写，向应用程序通知*完成*事件。在并发模式中，同步是程序完全按照代码序列顺序执行，异步是指程序的执行需要有事件驱动。

![image.png](assets/image-20210827174411-mqe8wmb.png)

异步线程效率高，但编写复杂，难以调试；同步线程逻辑简单，实时性较差。服务器通常同时使用同步线程和异步线程。

在半同步/半异步模式中，同步线程用于处理客户逻辑，异步线程用于处理IO事件，异步线程监听到客户请求后放入请求队列，工作线程读取请求队列并处理，

![image.png](assets/image-20210827175734-jfbz1v5.png)

* 异步线程只有一个，由主线程充当，负责监听所有socket上的事件：
  * 如果监听socket上有可读事件发生，即有新的连接请求到来，主线程就接受之，以得到新的连接socket，然后往epoll内核事件表中注册该socket上的读写事件。
  * 如果监听socket上有读写事件发生，即有新的客户请求或者有数据要发送到客户端，主线程就将该连接socket插入请求队列中
* 所有工作线程都睡眠在请求队列上，当有任务到来时，他们将通过竞争（比如申请互斥锁）获得任务的接管权。这种竞争机制使得只有空闲的工作线程才有机会来处理新任务

上图采用的Reactor事件处理模式。

### 领导者/追随者模式